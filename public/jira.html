<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jira í‹°ì¼“ ê´€ë¦¬</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .status-pending { @apply bg-yellow-100 text-yellow-800; }
    .status-in_progress { @apply bg-blue-100 text-blue-800; }
    .status-completed { @apply bg-green-100 text-green-800; }
    .status-failed { @apply bg-red-100 text-red-800; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="container mx-auto px-4 py-8">
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ« Jira í‹°ì¼“ ê´€ë¦¬</h1>
      <p class="text-gray-600">ChatGPTë¡œë¶€í„° ë°›ì€ ê°œë°œ ìš”ì²­ì„ ê´€ë¦¬í•©ë‹ˆë‹¤</p>
    </div>

    <div class="grid gap-4" id="tickets">
      <div class="text-center text-gray-500 py-8">
        í‹°ì¼“ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
      </div>
    </div>
  </div>

  <script>
    const statusLabels = {
      pending: 'ëŒ€ê¸° ì¤‘',
      in_progress: 'ì§„í–‰ ì¤‘',
      completed: 'ì™„ë£Œ',
      failed: 'ì‹¤íŒ¨'
    };

    const statusIcons = {
      pending: 'â³',
      in_progress: 'ğŸ”„',
      completed: 'âœ…',
      failed: 'âŒ'
    };

    async function loadTickets() {
      try {
        const response = await fetch('/jira/tickets');
        const tickets = await response.json();

        const container = document.getElementById('tickets');

        if (tickets.length === 0) {
          container.innerHTML = `
            <div class="text-center text-gray-500 py-8">
              <p class="text-xl">ğŸ“­ ì•„ì§ í‹°ì¼“ì´ ì—†ìŠµë‹ˆë‹¤</p>
              <p class="text-sm mt-2">ChatGPTì—ì„œ ì§€ì‹œì‚¬í•­ì„ ì „ì†¡í•˜ë©´ ì—¬ê¸°ì— ë‚˜íƒ€ë‚©ë‹ˆë‹¤</p>
            </div>
          `;
          return;
        }

        container.innerHTML = tickets.map(ticket => `
          <div class="bg-white rounded-lg shadow p-6 hover:shadow-lg transition-shadow">
            <div class="flex items-start justify-between mb-4">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-2xl">${statusIcons[ticket.status]}</span>
                  <span class="font-mono text-sm font-bold text-gray-700">${ticket.id}</span>
                  <span class="px-2 py-1 rounded-full text-xs font-semibold status-${ticket.status}">
                    ${statusLabels[ticket.status]}
                  </span>
                </div>
                <h3 class="text-lg font-semibold text-gray-800 mb-2">${ticket.title}</h3>
                <p class="text-gray-600 text-sm mb-3">${ticket.description.substring(0, 200)}${ticket.description.length > 200 ? '...' : ''}</p>

                <div class="text-xs text-gray-500 space-y-1">
                  <div>ğŸ“… ìƒì„±: ${new Date(ticket.createdAt).toLocaleString('ko-KR')}</div>
                  ${ticket.startedAt ? `<div>ğŸš€ ì‹œì‘: ${new Date(ticket.startedAt).toLocaleString('ko-KR')}</div>` : ''}
                  ${ticket.completedAt ? `<div>âœ… ì™„ë£Œ: ${new Date(ticket.completedAt).toLocaleString('ko-KR')}</div>` : ''}
                  ${ticket.projectPath ? `<div>ğŸ“ ê²½ë¡œ: ${ticket.projectPath}</div>` : ''}
                  ${ticket.filesCreated ? `<div>ğŸ“„ íŒŒì¼: ${ticket.filesCreated}ê°œ ìƒì„±</div>` : ''}
                  ${ticket.error ? `<div class="text-red-600">âŒ ì˜¤ë¥˜: ${ticket.error}</div>` : ''}
                </div>
              </div>

              <div>
                ${ticket.status === 'pending' ? `
                  <button
                    onclick="developTicket('${ticket.id}')"
                    class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold shadow-md hover:shadow-lg"
                  >
                    ğŸš€ ê°œë°œ
                  </button>
                ` : ticket.status === 'in_progress' ? `
                  <div class="px-6 py-3 bg-blue-100 text-blue-800 rounded-lg font-semibold">
                    ğŸ”„ ì§„í–‰ ì¤‘...
                  </div>
                ` : ticket.status === 'completed' ? `
                  <div class="px-6 py-3 bg-green-100 text-green-800 rounded-lg font-semibold">
                    âœ… ì™„ë£Œ
                  </div>
                ` : `
                  <button
                    onclick="developTicket('${ticket.id}')"
                    class="px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors font-semibold shadow-md hover:shadow-lg"
                  >
                    ğŸ”„ ì¬ì‹œë„
                  </button>
                `}
              </div>
            </div>
          </div>
        `).join('');

      } catch (error) {
        console.error('í‹°ì¼“ ë¡œë“œ ì˜¤ë¥˜:', error);
        document.getElementById('tickets').innerHTML = `
          <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
            âŒ í‹°ì¼“ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}
          </div>
        `;
      }
    }

    async function developTicket(ticketId) {
      if (!confirm(`${ticketId} í‹°ì¼“ ê°œë°œì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
      }

      try {
        const button = event.target;
        button.disabled = true;
        button.innerHTML = 'ğŸ”„ ê°œë°œ ì¤‘...';

        const response = await fetch(`/jira/develop/${ticketId}`, {
          method: 'POST'
        });

        const result = await response.json();

        if (response.ok) {
          alert(`âœ… ${result.message}\n\níŒŒì¼ ìƒì„±: ${result.filesCreated}ê°œ\nê²½ë¡œ: ${result.projectPath}`);
        } else {
          alert(`âŒ ê°œë°œ ì‹¤íŒ¨: ${result.error}`);
        }

        loadTickets();

      } catch (error) {
        console.error('ê°œë°œ ì‹¤í–‰ ì˜¤ë¥˜:', error);
        alert(`âŒ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
        loadTickets();
      }
    }

    // ì´ˆê¸° ë¡œë“œ
    loadTickets();

    // 5ì´ˆë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
    setInterval(loadTickets, 5000);
  </script>
</body>
</html>
